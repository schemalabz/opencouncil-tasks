name: Deploy PR Preview

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  pull-requests: write
  issues: write

# Only allow one deployment per PR at a time
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  CACHIX_CACHE_NAME: ${{ secrets.CACHIX_CACHE_NAME || 'opencouncil' }}

jobs:
  deploy:
    name: Build and Deploy Preview
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - name: Comment on PR (building)
        id: pr-comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const commitSha = context.payload.pull_request.head.sha.substring(0, 7);
            const logsUrl = context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Preview deployment')
            );

            const body = '## Preview deployment in progress\n\n'
              + '**Commit:** `' + commitSha + '`\n'
              + '**Status:** Building...\n\n'
              + 'Follow along in the [workflow logs](' + logsUrl + ').';

            let commentId;
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
              commentId = botComment.id;
            } else {
              const { data: newComment } = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
              commentId = newComment.id;
            }
            core.setOutput('comment-id', commentId);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-24.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: ${{ env.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          pushFilter: "opencouncil-tasks-prod"

      - name: Build production package
        run: |
          echo "Building opencouncil-tasks production package..."
          nix build .#opencouncil-tasks-prod --print-build-logs

      - name: Push to Cachix
        run: |
          echo "Pushing build to Cachix..."
          cachix push ${{ env.CACHIX_CACHE_NAME }} ./result

      - name: Get store path
        id: store-path
        run: |
          STORE_PATH=$(readlink ./result)
          echo "path=$STORE_PATH" >> $GITHUB_OUTPUT
          echo "Store path: $STORE_PATH"

      - name: Update PR comment (deploying)
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.pr-comment.outputs.comment-id }};
            const commitSha = context.payload.pull_request.head.sha.substring(0, 7);
            const logsUrl = context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;

            const body = '## Preview deployment in progress\n\n'
              + '**Commit:** `' + commitSha + '`\n'
              + '**Status:** Build complete, deploying to preview host...\n\n'
              + 'Follow along in the [workflow logs](' + logsUrl + ').';

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body,
            });

      - name: Deploy to preview host
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PREVIEW_DEPLOY_SSH_KEY }}
          PREVIEW_HOST: ${{ secrets.PREVIEW_HOST }}
          PREVIEW_USER: ${{ secrets.PREVIEW_USER || 'opencouncil' }}
          STORE_PATH: ${{ steps.store-path.outputs.path }}
        run: |
          set -euo pipefail

          PR_NUM="${{ github.event.pull_request.number }}"
          PORT=$((4000 + PR_NUM))

          echo "Deploying preview for PR #$PR_NUM on port $PORT"

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$PREVIEW_HOST" >> ~/.ssh/known_hosts

          SSH_CMD="ssh -i ~/.ssh/deploy_key ${PREVIEW_USER}@${PREVIEW_HOST}"

          # The droplet pulls the build from Cachix automatically (configured as a substituter).
          # Just SSH in and create the preview â€” nix-store --realise is called by the create script.
          echo "Creating/updating preview instance..."
          $SSH_CMD "sudo opencouncil-tasks-preview-create '$PR_NUM' '$STORE_PATH'"

          echo "### Preview Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Preview URL: https://pr-$PR_NUM.tasks.opencouncil.gr" >> $GITHUB_STEP_SUMMARY
          echo "Port: $PORT" >> $GITHUB_STEP_SUMMARY

      - name: Health check
        id: health-check
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          URL="https://pr-${PR_NUM}.tasks.opencouncil.gr/health"
          for i in $(seq 1 10); do
            HTTP_CODE=$(curl -sL -o /dev/null -w '%{http_code}' --max-time 10 "$URL" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "status=healthy" >> $GITHUB_OUTPUT
              echo "Preview is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_CODE, retrying..."
            sleep 3
          done
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          echo "Preview did not return HTTP 200 after 10 attempts"

      - name: Update PR comment (result)
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.pr-comment.outputs.comment-id }};
            const prNumber = context.payload.pull_request.number;
            const previewUrl = 'https://pr-' + prNumber + '.tasks.opencouncil.gr';
            const commitSha = context.payload.pull_request.head.sha.substring(0, 7);
            const healthStatus = '${{ steps.health-check.outputs.status }}';
            const logsUrl = context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;

            let body = '## Preview deployment ready!\n\n'
              + '**Preview URL:** ' + previewUrl + '\n'
              + '**Health check:** ' + previewUrl + '/health\n'
              + '**Commit:** `' + commitSha + '`\n\n'
              + 'The preview will be automatically updated when you push new commits.\n'
              + 'It will be destroyed when this PR is closed or merged.\n\n';

            if (healthStatus === 'unhealthy') {
              body += '> **Warning:** Health check failed - the preview did not respond with HTTP 200 after deployment. '
                + 'It may still be starting up, or there could be a runtime error. '
                + 'Check the [workflow logs](' + logsUrl + ') for details.\n\n';
            }

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body,
            });
